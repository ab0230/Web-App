<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Photos - PhotoShare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #f7f7f7;
        }

        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .photo-grid {
            columns: 300px;
            column-gap: 1.5rem;
        }

        .photo-card {
            break-inside: avoid;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .photo-card:hover {
            transform: translateY(-5px);
        }

        .photo-card img {
            width: 100%;
            border-radius: 1rem;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .star {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star:hover {
            transform: scale(1.2);
        }

        .star.active {
            fill: #fbbf24;
        }

        /* Enhanced button feedback */
        button {
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        button:hover {
            filter: brightness(1.1);
        }

        /* Specific button types */
        .glass:active {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Input and form element styling */
        input:focus, textarea:focus {
            outline: none;
            border-color: #4ecdc4 !important;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #ff6b6b;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <svg class="w-8 h-8 text-[#ff6b6b]" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                    </svg>
                    <h1 class="text-2xl font-bold">PhotoShare</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm" id="username"></span>
                    <button onclick="logout()" class="px-6 py-2 rounded-lg glass hover:bg-white/10 transition-all">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Search Section -->
        <div class="glass rounded-2xl p-8 mb-8">
            <h2 class="text-4xl font-bold mb-6">Explore Photos</h2>
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search by title, location, people..." 
                    class="w-full px-6 py-4 pl-14 rounded-xl bg-white/5 border border-white/10 focus:border-[#4ecdc4] focus:outline-none transition-all text-lg"
                >
                <svg class="w-6 h-6 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                </svg>
            </div>
        </div>

        <!-- Photos Grid -->
        <div id="photosContainer" class="photo-grid">
            <div class="col-span-full text-center py-12 text-gray-400">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[#ff6b6b] mx-auto mb-4"></div>
                <p>Loading photos...</p>
            </div>
        </div>

        <!-- Load More -->
        <div class="text-center mt-8">
            <button id="loadMoreBtn" onclick="loadMore()" class="px-8 py-3 rounded-lg bg-[#4ecdc4] hover:bg-[#4ecdc4]/80 font-semibold transition-all hidden">
                Load More
            </button>
        </div>
    </div>

    <!-- Photo Detail Modal -->
<div id="photoModal" class="modal">
    <div class="modal-content glass rounded-2xl p-8 max-w-5xl w-full mx-4">
        <div class="flex justify-between items-start mb-6">
            <h2 id="modalTitle" class="text-3xl font-bold"></h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <div>
                <img id="modalImage" class="w-full rounded-xl" src="" alt="">
                <video id="modalVideo" class="hidden w-full rounded-xl" controls></video>
            </div>
            <div>
                <div class="mb-6">
                    <p class="text-sm text-gray-400 mb-2">By <span id="modalUsername" class="text-[#4ecdc4] font-semibold"></span></p>
                    <p id="modalCaption" class="text-lg mb-4"></p>
                    
                    <div class="flex items-center gap-6 text-sm mb-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                            </svg>
                            <span id="modalLocation"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                            </svg>
                            <span id="modalViews"></span> views
                        </div>
                    </div>

                    <div id="modalPeople" class="mb-6"></div>
                </div>

                <!-- Rating -->
                <div class="mb-8 pb-8 border-b border-white/10">
                    <p class="text-sm font-semibold mb-3">Rate this photo:</p>
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1" id="ratingStars">
                            <svg class="star w-8 h-8 text-gray-400" onclick="ratePhoto(1)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                            <svg class="star w-8 h-8 text-gray-400" onclick="ratePhoto(2)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                            <svg class="star w-8 h-8 text-gray-400" onclick="ratePhoto(3)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                            <svg class="star w-8 h-8 text-gray-400" onclick="ratePhoto(4)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                            <svg class="star w-8 h-8 text-gray-400" onclick="ratePhoto(5)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 ml-2">Average: <span id="modalRating" class="text-yellow-500 font-semibold"></span></span>
                    </div>
                </div>

                <!-- Comments -->
                <div>
                    <h3 class="text-xl font-bold mb-4">Comments</h3>
                    <div id="commentsContainer" class="space-y-4 mb-6 max-h-64 overflow-y-auto">
                        <p class="text-gray-400 text-sm">No comments yet. Be the first to comment!</p>
                    </div>
                    <div id="commentForm" class="flex gap-2">
                        <input 
                            type="text" 
                            id="commentInput" 
                            placeholder="Add a comment..." 
                            class="flex-1 px-4 py-2 rounded-lg bg-white/5 border border-white/10 focus:border-[#4ecdc4] focus:outline-none transition-all"
                        >
                        <button onclick="postComment()" class="px-6 py-2 rounded-lg bg-[#4ecdc4] hover:bg-[#4ecdc4]/80 font-semibold transition-all">
                            Post
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || 'null');

    if (!token || !user) {
        window.location.href = '/';
    }

    document.getElementById('username').textContent = user.username;

    let currentPage = 1;
    let totalPages = 1;
    let currentSearch = '';
    let currentPhotoId = null;

    // Load photos - FIXED: Changed from /api/photos to /api/media
    async function loadPhotos(page = 1, search = '') {
        try {
            const response = await fetch(`/api/media?page=${page}&limit=12&search=${encodeURIComponent(search)}`);
            const data = await response.json();

            if (response.ok) {
                const container = document.getElementById('photosContainer');
                
                if (page === 1) {
                    container.innerHTML = '';
                }

                if (data.media.length === 0 && page === 1) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p>No photos found</p>
                        </div>
                    `;
                } else {
                    data.media.forEach(photo => {
                        const card = document.createElement('div');
                        card.className = 'photo-card glass rounded-2xl overflow-hidden';
                        card.onclick = () => openPhotoModal(photo.id);
                        
                        const mediaIcon = photo.media_type === 'video' ? 
                            `<div class="absolute top-2 right-2 bg-black/60 rounded-full p-2">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                                </svg>
                            </div>` : '';
                        
                        card.innerHTML = `
                            <div class="relative">
                                <img src="${photo.thumbnail_url}" alt="${photo.title}">
                                ${mediaIcon}
                            </div>
                            <div class="p-4">
                                <h3 class="font-bold text-lg mb-2">${photo.title}</h3>
                                <p class="text-sm text-gray-400 mb-2">by ${photo.username}</p>
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center gap-3">
                                        <span class="flex items-center gap-1">
                                            <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                            </svg>
                                            ${photo.avg_rating}
                                        </span>
                                        <span class="flex items-center gap-1 text-gray-400">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                                            </svg>
                                            ${photo.comment_count}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }

                currentPage = data.page;
                totalPages = data.pages;

                const loadMoreBtn = document.getElementById('loadMoreBtn');
                if (currentPage < totalPages) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            }
        } catch (error) {
            console.error('Error loading photos:', error);
        }
    }

    function loadMore() {
        loadPhotos(currentPage + 1, currentSearch);
    }

    // Search
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentSearch = e.target.value;
            currentPage = 1;
            loadPhotos(1, currentSearch);
        }, 500);
    });

    // Photo modal - FIXED: Changed from /api/photos to /api/media
    async function openPhotoModal(photoId) {
        currentPhotoId = photoId;
        try {
            const response = await fetch(`/api/media/${photoId}`);
            const photo = await response.json();

            if (response.ok) {
                document.getElementById('modalTitle').textContent = photo.title;
                
                const modalImage = document.getElementById('modalImage');
                const modalVideo = document.getElementById('modalVideo');
                
                if (photo.media_type === 'video') {
                    modalImage.classList.add('hidden');
                    modalVideo.classList.remove('hidden');
                    modalVideo.src = photo.url;
                } else {
                    modalVideo.classList.add('hidden');
                    modalImage.classList.remove('hidden');
                    modalImage.src = photo.url;
                }
                
                document.getElementById('modalUsername').textContent = photo.username;
                document.getElementById('modalCaption').textContent = photo.caption || 'No caption';
                document.getElementById('modalLocation').textContent = photo.location || 'Unknown location';
                document.getElementById('modalViews').textContent = photo.views;
                document.getElementById('modalRating').textContent = photo.avg_rating;

                if (photo.people_present) {
                    document.getElementById('modalPeople').innerHTML = `
                        <p class="text-sm mb-2">People in this photo:</p>
                        <div class="flex flex-wrap gap-2">
                            ${photo.people_present.split(',').map(person => `
                                <span class="px-3 py-1 rounded-full bg-white/5 text-sm">${person.trim()}</span>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('modalPeople').innerHTML = '';
                }

                await loadUserRating(photoId);
                await loadComments(photoId);
                document.getElementById('photoModal').classList.add('active');
            }
        } catch (error) {
            console.error('Error loading photo:', error);
        }
    }

    function closeModal() {
        document.getElementById('photoModal').classList.remove('active');
        const modalVideo = document.getElementById('modalVideo');
        if (modalVideo) {
            modalVideo.pause();
            modalVideo.src = '';
        }
        currentPhotoId = null;
    }

    // Rating - FIXED: Changed from /api/photos to /api/media
    async function loadUserRating(photoId) {
        try {
            const response = await fetch(`/api/media/${photoId}/rating`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            updateStars(response.ok && data.rating ? data.rating : 0);
        } catch (error) {
            console.error('Error loading rating:', error);
        }
    }

    async function ratePhoto(rating) {
        if (!currentPhotoId) return;
        try {
            const response = await fetch(`/api/media/${currentPhotoId}/rating`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ rating })
            });

            const data = await response.json();
            if (response.ok) {
                updateStars(rating);
                document.getElementById('modalRating').textContent = data.avg_rating;
            } else {
                alert(data.error || 'Failed to rate photo');
            }
        } catch (error) {
            console.error('Error rating photo:', error);
        }
    }

    function updateStars(rating) {
        const stars = document.querySelectorAll('#ratingStars .star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }

    // Comments - FIXED: Changed from /api/photos to /api/media
    async function loadComments(photoId) {
        try {
            const response = await fetch(`/api/media/${photoId}/comments`);
            const comments = await response.json();
            const container = document.getElementById('commentsContainer');

            if (response.ok && comments.length > 0) {
                container.innerHTML = comments.map(comment => `
                    <div class="glass rounded-lg p-4">
                        <p class="text-sm font-semibold mb-1">${comment.username}</p>
                        <p class="text-sm">${comment.text}</p>
                        <p class="text-xs text-gray-500 mt-2">${new Date(comment.created_at).toLocaleString()}</p>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-gray-400 text-sm">No comments yet. Be the first to comment!</p>';
            }
        } catch (error) {
            console.error('Error loading comments:', error);
        }
    }

    async function postComment() {
        if (!currentPhotoId) return;
        const commentInput = document.getElementById('commentInput');
        const comment = commentInput.value.trim();
        if (!comment) return;

        try {
            const response = await fetch(`/api/media/${currentPhotoId}/comments`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comment })
            });

            if (response.ok) {
                commentInput.value = '';
                await loadComments(currentPhotoId);
            } else {
                const data = await response.json();
                alert(data.error || 'Failed to post comment');
            }
        } catch (error) {
            console.error('Error posting comment:', error);
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('photoModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    loadPhotos();
    </script>
</body>
</html>
